<!DOCTYPE html>
<html lang="kr" >
    <head>
        <title>
            
        </title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="home.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <tag autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        <script src="Resource/jquery-3.4.1.min.js" charset="utf-8"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
        <link rel="stylesheet" href="Resource/fontawesome/css/all.css"> <!--this enabled when it can't access fontawesome web site-->
    </head>
    <body>
      <form class="frame">
          <div class="container">
            <div class="content" id="temp-controller">
              <i class="fas fa-temperature-high"></i>
              <span>온도 조절</span>
            </div>
            <div class="content" id="LED">
              <i class="fas fa-lightbulb"></i>
              <span>LED 제어</span>
            </div>
            <div class="content" id="album">
              <i class="far fa-images"></i>
              <span>글자 액자</span>
            </div><br>
            <div class="content" id="doorLock">
              <i class="fas fa-door-open"></i>
              <span>도어락 제어</span>
            </div>
            <div class="content" id="plug">
              <i class="fas fa-plug"></i>
              <span>전원 확인</span>
            </div>
          </div>
      </form>

      <div class="search-screen">
          <i class="fas fa-search search-icon"></i>
          <div class="search-box">
            <input type="text" class="search-txt" placeholder="전송할 메세지" maxlength="32"  onkeydown="fn_press_han(this);" style="ime-mode:disabled;">
            <button class="search-btn"><i class="far fa-paper-plane"></i></button>
          </div>
        </div>
    </body>
    <script type="text/javascript">
      var WebSocket_Buffer, WebSocket_String="";
      var isFirstInput=true, isFocused=false;
		  var isPageMove=false;
      var i;
      $(document).ready(function(){
        $(".search-icon").hide();
        $(".search-btn").hide();

        if(!isWebSocketConnected)
        {
          WebSocket_Connect();
        }

        if(isWebSocketConnected)
        {
          alert("Connected...");
        }

        if(WebSocket_String.length>0)
        {
          $(".search-txt").val(WebSocket_String);
        }
      });

        $('#temp-controller').click(function(){
          location.href = "temperature_controller.html";
        });
        $('#LED').click(function(){
          location.href = "LED.html";
        });
        $('#album').click(function(){
          $(".search-icon").trigger('click');
        });
        $('#doorLock').click(function(){
          location.href = "doorLock.html";
        });
        $('#plug').click(function(){
          location.href = "plug.html";
        });
        
        $(".search-icon").click(function(){
          $(this).toggleClass("fa-times");
          $(".search-screen").toggleClass("active");
        $(".search-icon").toggle();
        });

        $(".search-txt").keyup(function(e){
          if($(this).val() != ""){
            $(".search-btn").show();
            $(".search-btn").css("opacity",1);
            $(".search-btn").css("transform","rotate(0deg)");
          }else{
            $(".search-btn").hide();
            $(".search-btn").css("opacity",0);
            $(".search-btn").css("transform","rotate(45deg)");
          }

          if(e.keyCode==13)
            $(".search-btn").trigger("click");
        });

        $(".search-btn").click(function(){
          if($(".search-txt").val().length==0)
            return;

          WebSocket_Buffer=new Uint8Array(2+$(".search-txt").val().length);
          WebSocket_Buffer[0]=4;// Code CLCD Message which is going to set.
          WebSocket_Buffer[1]=$(".search-txt").val().length;
          for(i=0;i<$(".search-txt").val().length;i++)
            WebSocket_Buffer[2+i]=$(".search-txt").val().charCodeAt(i);
          ws.send(WebSocket_Buffer);
          alert($(".search-txt").val()+"를 전송하였습니다.");
          $(".search-txt").blur();
        });

        /* 한글입력 방지 */
      function fn_press_han(obj)
      {
          //좌우 방향키, 백스페이스, 딜리트, 탭키에 대한 예외
          if(event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 37 || event.keyCode == 39
          || event.keyCode == 46 ) return;
          //obj.value = obj.value.replace(/[\a-zㄱ-ㅎㅏ-ㅣ가-힣]/g, '');
          obj.value = obj.value.replace(/[\ㄱ-ㅎㅏ-ㅣ가-힣]/g, '');

          if(isFirstInput)
          {
            isFirstInput=true;
          }
      }
      var WAS_PORTNUM="8080";
      var WebSocket_URL= "ws://192.168.1.5:"+WAS_PORTNUM;//"ws://anuICE.iptime.org:"+WAS_PORTNUM;
      var ws;
      var isWebSocketConnected=false; // 페이지를 벗어날때, WebSocket종료시 엣지브라우저에서 'WebSocket Error'가 일어나는 것을 해결하기 위한 데이터
      var isWindowUnload=false;
      var isToldError_when_occured=false;
      window.onbeforeunload=function(e){
        isWindowUnload=true;
        isPageMove=true;
        ws.close();
                //return '페이지를 나가시겠습니까?';
      };

      function WebSocket_Connect()
      {
        ws=new WebSocket(WebSocket_URL);
        ws.onopen = WebSocket_onOpen;
        ws.onmessage = Websocket_onMessage;
        ws.onclose = WebSocket_onClose;
        ws.onerror = WebSocket_onError;
        isToldError_when_occured=false;
      }

      function WebSocket_onOpen(e)
      {
        //txtRecv.append( "connected<br>" );
        isWebSocketConnected=true;
        //alert("connected");
        
        if(sessionStorage.getItem("isFirstSessionConnected") != "Yes")
				{
          alert("보드와 연결되었습니다.");
          sessionStorage.setItem("isFirstSessionConnected","Yes");
        }
      }

      var reader = new FileReader();
      reader.addEventListener("loadend", function(e) {
			  // if the server sent binary array. (function : Websocket_onMessage(e))
			  var recvBuf=new Uint8Array(e.srcElement.result);
        if(recvBuf[0]==3) // CLCD Message on board when not connected
        {
          for(i=0;i<recvBuf[1];i++)
          {
            WebSocket_String+=String.fromCharCode(recvBuf[2+i]);
          }
        }
        else if(recvBuf[0]==4) // Current CLCD Message on board
        {
          WebSocket_String="";
          for(i=0;i<recvBuf[1];i++)
            WebSocket_String+=String.fromCharCode(recvBuf[2+i]);
        }

        if(!isFocused && WebSocket_String.length > 0)
          $(".search-txt").val("현재 설정된 메세지 : "+WebSocket_String);
      });

      function Websocket_onMessage(e)
      {
        if(e.data instanceof Blob)
          reader.readAsArrayBuffer(e.data);
        else
        {
					// if the server sent string(message).
					alert(e.data);
				}
      }

      function WebSocket_onClose(e)
      {
        isWebSocketConnected=false;
        //alert("closed");
        if(!isPageMove)
				  alert("임베디드 보드와 연결이 끊어졌습니다.\n컴퓨터와 임베디드 보드의 인터넷 연결을 확인하세요.")
      }

      function WebSocket_onError(e)
      {
        if(!isWebSocketConnected && !isToldError_when_occured)
        {
          if(!isPageMove)
            alert("임베디드 보드와 연결할 수 없습니다.\n컴퓨터와 임베디드 보드의 인터넷 연결을 확인하세요.");
          isToldError_when_occured=true;
        }
        isWebSocketConnected=false;
      }

      
      $(".search-txt").on("focus",function(){
        //if(isFirstInput)
        {
          $(this).addClass("focus");
          //alert("on focus");
          isFocused=true;
          if(isFirstInput)
          {
            $(".search-txt").val(WebSocket_String);
          }
        }
        });
        $(".search-txt").on("blur",function(){
          //if(isFirstInput)
          {
            $(this).removeClass("focus");
            //alert("out focus");
            isFocused=false;
            if(isFirstInput)
            {
              $(".search-txt").val("현재 설정된 메세지 : "+WebSocket_String);
            }
          }
        });

    </script>
  </html>
  